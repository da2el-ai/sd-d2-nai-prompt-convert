{"version":3,"file":"d2_nai_prompt_convert.js","sources":["../src/js/D2NPCPromptConvert.ts","../src/js/D2NPCModal.ts","../src/js/index.ts"],"sourcesContent":["class D2NPCPromptConvert {\n    static RATE = 1.05;\n\n    static convertToNai(srcPrompt: string) {\n        const tempPrompt = srcPrompt.replace(/\\n/g, '');\n        const convertedPrompt = tempPrompt.replace(/\\([^)]+:\\s*[0-9.]+\\s*\\)/g, D2NPCPromptConvert.$_convertToNai);\n        return convertedPrompt;\n    }\n\n    static $_convertToNai(prompt: string) {\n        const parts = prompt.substring(1, prompt.length - 1).split(':');\n        const text = parts.slice(0, -1).join(':').trim();\n        const weightStr = parts[parts.length - 1].trim();\n        const weight = parseFloat(weightStr);\n        const n = Math.round(Math.log(weight) / Math.log(D2NPCPromptConvert.RATE));\n        const count = Math.abs(n);\n\n        let openBra, closeBra;\n        if (weight < 1) {\n            openBra = '[';\n            closeBra = ']';\n        } else {\n            openBra = '{';\n            closeBra = '}';\n        }\n\n        return openBra.repeat(count) + text + closeBra.repeat(count);\n    }\n\n    static convertToSd(srcPrompt: string) {\n        let tempPrompt = srcPrompt.replace(/\\n/g, '');\n        let convertedPrompt = tempPrompt.replace(/{+[^}]+}+/g, D2NPCPromptConvert.$_convertToSd);\n        return convertedPrompt;\n    }\n\n    static $_convertToSd(prompt: string) {\n        const braceCount = (prompt.match(/{/g) || []).length;\n        const weight = 1 * Math.pow(D2NPCPromptConvert.RATE, braceCount);\n        const weightAdjust = Math.floor(weight * 100) / 100;\n        const text = prompt.replace(/[{}]+/g, '');\n        return `(${text}:${weightAdjust})`;\n    }\n}\n\nexport { D2NPCPromptConvert };\n","import { D2NPCPromptConvert } from './D2NPCPromptConvert';\n\nclass D2NPCModalElementBuilder {\n    static promptAreaElement(placeholder: string) {\n        const textArea = document.createElement('textarea');\n        textArea.classList.add('d2-npc-prompt-area');\n        textArea.placeholder = placeholder;\n        return textArea;\n    }\n\n    static buttonElement(text: string, onClick: () => void) {\n        const btn = document.createElement('button');\n        btn.classList.add('d2-npc-btn');\n        btn.textContent = text;\n        btn.addEventListener('click', () => {\n            onClick();\n        });\n        return btn;\n    }\n}\n\n///////////////////////////////\n///////////////////////////////\n///////////////////////////////\n\nclass D2NPCModal {\n    modalContainer: HTMLDialogElement;\n    sdPrompt: HTMLTextAreaElement;\n    naiPrompt: HTMLTextAreaElement;\n\n    constructor() {\n        this.modalContainer = document.createElement('dialog');\n        this.modalContainer.classList.add('d2-npc-modal');\n        document.querySelector('body')?.appendChild(this.modalContainer);\n\n        this.sdPrompt = D2NPCModalElementBuilder.promptAreaElement('SDプロンプトを入力');\n        this.modalContainer.appendChild(this.sdPrompt);\n\n        this.naiPrompt = D2NPCModalElementBuilder.promptAreaElement('NAIプロンプトを入力');\n        this.modalContainer.appendChild(this.naiPrompt);\n\n        // SD > NAI 変換ボタン\n        const sdToNaiBtn = D2NPCModalElementBuilder.buttonElement('SD to NAI', () => {\n            const prompt = this.sdPrompt.value;\n            const newPrompt = D2NPCPromptConvert.convertToNai(prompt);\n            this.naiPrompt.value = newPrompt;\n        });\n        this.modalContainer.appendChild(sdToNaiBtn);\n\n        // NAI > SD 変換ボタン\n        const naiToSdBtn = D2NPCModalElementBuilder.buttonElement('NAI to SD', () => {\n            const prompt = this.naiPrompt.value;\n            const newPrompt = D2NPCPromptConvert.convertToSd(prompt);\n            this.sdPrompt.value = newPrompt;\n        });\n        this.modalContainer.appendChild(naiToSdBtn);\n\n        // SDクリップボード\n        const copySdBtn = D2NPCModalElementBuilder.buttonElement('Send SD to Clipboard', () => {\n            this.sdPrompt.select();\n            document.execCommand('copy');\n        });\n        this.modalContainer.appendChild(copySdBtn);\n\n        // NAIクリップボード\n        const copyNaiBtn = D2NPCModalElementBuilder.buttonElement('Send NAI to Clipboard', () => {\n            this.naiPrompt.select();\n            document.execCommand('copy');\n        });\n        this.modalContainer.appendChild(copyNaiBtn);\n\n        // 閉じるボタン\n        const closeBtn = document.createElement('button');\n        closeBtn.classList.add('d2-npc-close-btn');\n        closeBtn.textContent = '×';\n        closeBtn.addEventListener('click', () => {\n            this.modalContainer.close();\n        });\n        this.modalContainer.appendChild(closeBtn);\n    }\n\n    /**\n     * モーダルの表示\n     */\n    showModal() {\n        this.modalContainer.showModal();\n    }\n}\n\nexport { D2NPCModal };\n","declare var gradioApp: any;\ndeclare var onUiLoaded: any;\n\nimport { D2NPCModal } from './D2NPCModal';\n\nonUiLoaded(async () => {\n    const enableCheckbox = gradioApp().getElementById('d2_npc_enable');\n\n    const txt2imgActionColumn = gradioApp().getElementById('txt2img_actions_column');\n    const container = document.createElement('div');\n    container.classList.add('d2_npc_container');\n    container.appendChild(enableCheckbox);\n\n    txt2imgActionColumn.appendChild(container);\n\n    // プロンプト変換モーダル\n    const convertModal = new D2NPCModal();\n\n    // プロンプト変換モーダル表示ボタン\n    const showBtn = document.createElement('button');\n    showBtn.classList.add('d2-npc-show-modal-btn');\n    showBtn.textContent = 'Show NAI converter';\n    showBtn.addEventListener('click', () => {\n        convertModal.showModal();\n    });\n    document.querySelector('body')?.appendChild(showBtn);\n});\n"],"names":[],"mappings":"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"}